<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Allwinner S3 SoC: Accelerated h.264 | Greg Davill's Projects</title>
<meta name=keywords content><meta name=description content="Introduction I&rsquo;ve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:
S3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (&ldquo;Allwinner&rdquo;) and Sochip Technology Co., Ltd. (&ldquo;Sochip&rdquo;). Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development."><meta name=author content><link rel=canonical href=https://gregdavill.com/posts/allwinner-s3-videoencoders/><link crossorigin=anonymous href=/assets/css/stylesheet.c67fb9d44b5a68d22242044c9bddb70c39d78233626c1c25a01ce8ce7c4bb761.css integrity="sha256-xn+51EtaaNIiQgRMm923DDnXgjNibBwloBzoznxLt2E=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://gregdavill.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://gregdavill.com/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://gregdavill.com/favicon-32x32.png><link rel=apple-touch-icon href=https://gregdavill.com/apple-touch-icon.png><link rel=mask-icon href=https://gregdavill.com/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://gregdavill.com/posts/allwinner-s3-videoencoders/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="Allwinner S3 SoC: Accelerated h.264"><meta property="og:description" content="Introduction I&rsquo;ve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:
S3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (&ldquo;Allwinner&rdquo;) and Sochip Technology Co., Ltd. (&ldquo;Sochip&rdquo;). Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development."><meta property="og:type" content="article"><meta property="og:url" content="https://gregdavill.com/posts/allwinner-s3-videoencoders/"><meta property="og:image" content="https://gregdavill.com/posts/allwinner-s3-videoencoders/images/002.jpeg"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-12T21:00:00+10:30"><meta property="article:modified_time" content="2022-07-12T21:00:00+10:30"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://gregdavill.com/posts/allwinner-s3-videoencoders/images/002.jpeg"><meta name=twitter:title content="Allwinner S3 SoC: Accelerated h.264"><meta name=twitter:description content="Introduction I&rsquo;ve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:
S3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (&ldquo;Allwinner&rdquo;) and Sochip Technology Co., Ltd. (&ldquo;Sochip&rdquo;). Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://gregdavill.com/posts/"},{"@type":"ListItem","position":2,"name":"Allwinner S3 SoC: Accelerated h.264","item":"https://gregdavill.com/posts/allwinner-s3-videoencoders/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Allwinner S3 SoC: Accelerated h.264","name":"Allwinner S3 SoC: Accelerated h.264","description":"Introduction I\u0026rsquo;ve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:\nS3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (\u0026ldquo;Allwinner\u0026rdquo;) and Sochip Technology Co., Ltd. (\u0026ldquo;Sochip\u0026rdquo;). Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development.","keywords":[],"articleBody":" Introduction I‚Äôve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:\nS3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (‚ÄúAllwinner‚Äù) and Sochip Technology Co., Ltd. (‚ÄúSochip‚Äù). Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development. ‚Äî http://www.sochip.com.cn/s3/index.php?title=What_is_S3_%3F\nWhat was appealing to me for use with the Boson thermal camera is the compact BGA package, the internal DRAM, and embedded ethernet 100 Mbit PHY. Interestingly the CPU used inside is the same as the V3/V3s/S3, there is mainline kernel and uboot support. This is good because I‚Äôm very much an embedded Linux beginner.\nAfter following the reference design provided by SOChip, along with some other great OSHW projects:\nOtterCam-s3 OtterCast S3-OLinuXino I had a custom board designed. After some quick assembly I had a board that powered up. Soon after that with a custom buildroot project, and had linux 5.18 booted on the board. üôå\nH264 Encoder After some initial testing with libopenh264 with ffmpeg the performance is not great. Achieving only a few fps encoding an incoming USB UVC stream into h264. Not a dealbreaker for this project.\nThe S3 contains a hardware encoding block that claims performance of 120FPS, this block is the same across many Allwinner parts. One such part is the H3. Unfortunately it‚Äôs not documented by Allwinner. If you want to make use of the codec you‚Äôll need to use the older kernel provided by Allwinner, and their cedar core.\nCedrus is an open source alternative that makes use of community documentation of the codec registers. It‚Äôs available upstream in the kernel. Great! Except it only handles decoding not encoding. :(\nSearching around I found some older posts talking about hw encode on the Allwinner H3.\nhttps://forum.armbian.com/topic/11551-4kp30-video-on-orange-pi-lite-and-mainline-hardware-acceleration/page/2/#comment-89815\nThey mentioned these components:\nhttps://github.com/uboborov/sunxi-cedar-mainline https://github.com/uboborov/ffmpeg_h264_H3 https://github.com/uboborov/cedrus sunxi-cedar-mainline This is a kernel module which when loaded creates /dev/cedar_ve. This file facilitates the interaction from a userspace app to the low level codec block. What is interesting is that this project specifically list Kernel 5.7, with config. It makes use of the CMA, Continuous Memory Allocator, a part of the Linux mainline Kernel. Many repos for ‚Äúcedar‚Äù seem to use an older ION system from Android, and are pinned to old kernel versions.\nffmpeg_h264_H3 This is a custom encoder that compiles into FFmpeg. Unfortunately this version does make use of ION, which creates a bit of a disconnect between the kernel module and the userspace code‚Ä¶ :/\ncedrus These small utilities are super handy, they‚Äôre small single purpose applications h264enc, jpeg-test, mpeg-test.\nThe code makes use of the CMA, and also the functions and code layout match up pretty perfectly to the FFmpeg encoder code. Combining this code into the FFmpeg looks like it might be the way to go.\nBuilding So it looks like we have all the pieces for this puzzle but can we put them together..\nA very simple package is added buildroot project to compile the kernel module, this also installs the module into the target filesystem.\n################################################################################ # # cedar-mainline # ################################################################################ CEDAR_VERSION = cb9ea3d9894fd88a5b7f67fea220ceaa5ed17656 CEDAR_SITE = $(call github,gregdavill,sunxi-cedar-mainline,$(CEDAR_VERSION)) CEDAR_LICENSE = GPL-2.0 CEDAR_LICENSE_FILES = LICENSE $(eval $(kernel-module)) $(eval $(generic-package)) Along with the kernel module, we need to enable the CMA, because we only have 128MB to work with I first started with 64MB.\ndefconfig + CONFIG_DMA_CMA=y + CONFIG_CMA_SIZE_MBYTES=64 sun8i.dtsi reserved-memory { #address-cells = \u003c1\u003e; #size-cells = \u003c1\u003e; ranges; cma_pool: default-pool { alloc-ranges = \u003c0x40000000 0x8000000\u003e; // Start Addr + Length compatible = \"shared-dma-pool\"; linux,cma-default; reusable; alignment = \u003c0x2000\u003e; size = \u003c0x4000000\u003e; /* 64MB */ }; }; syscon: syscon@1c00000 { compatible = \"allwinner,sun8i-v3s-system-controller\", \"allwinner,sun8i-h3-system-control\", \"syscon\"; reg = \u003c0x01c00000 0xd0\u003e; #address-cells = \u003c1\u003e; #size-cells = \u003c1\u003e; ranges; sram_c: sram@4000 { compatible = \"mmio-sram\"; reg = \u003c0x4000 0xa000\u003e; #address-cells = \u003c1\u003e; #size-cells = \u003c1\u003e; ranges = \u003c0 0x4000 0xa000\u003e; ve_sram: sram-section@0 { compatible = \"allwinner,sun8i-v3s-sram-c\", \"allwinner,sun4i-a10-sram-c1\"; reg = \u003c0x000000 0xa000\u003e; }; }; }; ve: video-engine@01c0e000 { compatible = \"allwinner,sunxi-cedar-ve\"; reg = \u003c0x01c0e000 0x1000\u003e, \u003c0x01c00000 0x10\u003e, \u003c0x01c20000 0x800\u003e; memory-region = \u003c\u0026cma_pool\u003e; syscon = \u003c\u0026syscon\u003e; clocks = \u003c\u0026ccu CLK_BUS_VE\u003e, \u003c\u0026ccu CLK_VE\u003e, \u003c\u0026ccu CLK_DRAM_VE\u003e; clock-names = \"ahb\", \"mod\", \"ram\"; resets = \u003c\u0026ccu RST_BUS_VE\u003e; interrupts = ; allwinner,sram = \u003c\u0026ve_sram 1\u003e; }; A lot of the references I‚Äôve seen online to working with this codec seem to set sram_c to 0x1d00000. Which seems to be an empty section of memory, according to the official memory map. So I‚Äôve set my device tree to point to the sram_c defined in the S3 datasheet, this seems to work correctly, atleast for my use cases.\nKernel output [ 0.000000] Reserved memory: created CMA memory pool at 0x43c00000, size 64 MiB [ 0.000000] OF: reserved mem: initialized node default-pool, compatible id shared-dma-pool ... [ 0.000000] Zone ranges: [ 0.000000] Normal [mem 0x0000000040000000-0x0000000047ffffff] [ 0.000000] HighMem empty [ 0.000000] Memory: 50136K/131072K available (8192K kernel code, 1478K rwdata, 2800K rodata, 1024K init, 240K bss, 15400K reserved, 65536K cma-reserved, 0K highmem) ... # modprobe cedar_ve [ 9.202456] cedar_ve: loading out-of-tree module taints kernel. [ 9.210073] sunxi cedar version 0.1 [ 9.213939] [cedar]: install start!!! [ 9.217684] cedar_ve: cedar-ve the get irq is 23 [ 9.222323] sunxi-cedar 1c0e000.video-engine: assigned reserved memory node default-pool [ 9.230624] [cedar]: Success claim SRAM [ 9.338704] [cedar]: memory allocated at address PA: 43D00000, VA: C3D00000 [ 9.345749] [cedar]: install end!!! Success! ü•≥\nThe first time I tried this I hit an error trying to allocate memory, because it was attempting to allocate 80MB. Easy fix. Might be better suited to be set up the ve_size as a device tree parameter.\ndiff --git a/cedar_ve.c b/cedar_ve.c index 2f6f744..c73ea88 100644 --- a/cedar_ve.c +++ b/cedar_ve.c @@ -1804,7 +1804,7 @@ static int cedardev_init(struct platform_device *pdev) #endif /*LINUX_VERSION_CODE \u003e= KERNEL_VERSION(4,11,0)*/ #if !defined(USE_ION) -\tcedar_devp-\u003eve_size = 80 * SZ_1M; +\tcedar_devp-\u003eve_size = 32 * SZ_1M; ret = dma_set_coherent_mask(cedar_devp-\u003edev, DMA_BIT_MASK(32)); if (ret) { dev_err(cedar_devp-\u003edev, \"DMA enable failed\\n\"); New we have the kernel module loaded it‚Äôs time to set up FFmpeg. Here is a diff I‚Äôve applied to FFmpeg 4.4\nResults Not an apple to oranges comparison, because the h264 parameters are different. But you can see even on the ‚Äúultrafast‚Äù preset, the speed can‚Äôt keep up with a measly 30 fps 640x512 stream.\n# ffmpeg -f v4l2 -video_size 640x512 -pix_fmt nv12 -i /dev/video0 -r 30 -c:v cedrus264 -vewait 5 -b:v 4M -maxrate 4M -qp 30 -t 5 -f mp4 test.mp4 -y frame= 150 fps= 30 q=-0.0 Lsize= 558kB time=00:00:04.96 bitrate= 921.1kbits/s speed=0.994x # ffmpeg -f v4l2 -video_size 640x512 -pix_fmt nv12 -i /dev/video0 -r 30 -c:v libx264 -b:v 4M -maxrate 4M -bufsize 1M -preset ultrafast -t 5 -f mp4 test.mp4 -y frame= 150 fps= 20 q=7.0 Lsize= 2380kB time=00:00:04.96 bitrate=3925.5kbits/s dup=24 drop=0 speed=0.66x I‚Äôve only really started to poke around with the encoder support. But hope this write-up encourages you to give it a spin too! I‚Äôd love to see any projects you come up with utilizing the Allwinner S3!\n","wordCount":"1177","inLanguage":"en","image":"https://gregdavill.com/posts/allwinner-s3-videoencoders/images/002.jpeg","datePublished":"2022-07-12T21:00:00+10:30","dateModified":"2022-07-12T21:00:00+10:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://gregdavill.com/posts/allwinner-s3-videoencoders/"},"publisher":{"@type":"Organization","name":"Greg Davill's Projects","logo":{"@type":"ImageObject","url":"https://gregdavill.com/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://gregdavill.com/ accesskey=h title="Greg Davill's Projects (Alt + H)">Greg Davill's Projects</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://gregdavill.com/archives title=Archive><span>Archive</span></a></li><li><a href=https://gregdavill.com/categories/ title=Categories><span>Categories</span></a></li><li><a href=https://gregdavill.com/search/ title="Search (Alt + /)" accesskey=/><span>Search</span></a></li><li><a href=https://gregdavill.com/tags/ title=Tags><span>Tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://gregdavill.com/>Home</a>&nbsp;¬ª&nbsp;<a href=https://gregdavill.com/posts/>Posts</a></div><h1 class=post-title>Allwinner S3 SoC: Accelerated h.264</h1><div class=post-meta>&lt;span title='2022-07-12 21:00:00 +1030 +1030'>July 12, 2022&lt;/span>&amp;nbsp;¬∑&amp;nbsp;6 min&nbsp;|&nbsp;<a href=https://github.com/gregdavill/gregdavill.github.io/blob/main/blog-src/content/posts/allwinner-s3-videoencoders/index.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><figure><img srcset="/posts/allwinner-s3-videoencoders/images/002_hub7807efb153d309fb368d53b91aa3f68_1042717_390x0_resize_q95_lanczos.jpeg 390w,
/posts/allwinner-s3-videoencoders/images/002_hub7807efb153d309fb368d53b91aa3f68_1042717_800x0_resize_q95_lanczos.jpeg 800w,
/posts/allwinner-s3-videoencoders/images/002_hub7807efb153d309fb368d53b91aa3f68_1042717_2160x0_resize_q95_lanczos.jpeg 2160w" src=/posts/allwinner-s3-videoencoders/images/002_hub7807efb153d309fb368d53b91aa3f68_1042717_800x0_resize_q95_lanczos.jpeg alt></figure><h2 id=introduction>Introduction<a hidden class=anchor aria-hidden=true href=#introduction>#</a></h2><p>I&rsquo;ve been using an Allwinner S3 SoC for experiments with the FLIR Boson. The description from the website sums the device up nicely:</p><blockquote><p>S3 is a high cost-effective video encoding processor jointly developed by Zhuhai Allwinner Technology Co., Ltd. (&ldquo;Allwinner&rdquo;) and Sochip Technology Co., Ltd. (&ldquo;Sochip&rdquo;).
Its built-in single-core ARM Cortex-A7 runs at 1.2GHz with 1Gbit DRAM (DDR3) , supporting numerous peripheral devices. The Chip package is 234 balls FBGA package, size 11mm x 11mm , suitable for various types of product development.
&mdash; <a href="http://www.sochip.com.cn/s3/index.php?title=What_is_S3_%3F">http://www.sochip.com.cn/s3/index.php?title=What_is_S3_%3F</a></p></blockquote><figure><img srcset="/posts/allwinner-s3-videoencoders/images/Cpuarch_hufaef179a65db8d6c26b65a1ab82f38fa_77711_390x0_resize_lanczos_3.png 390w,
/posts/allwinner-s3-videoencoders/images/Cpuarch_hufaef179a65db8d6c26b65a1ab82f38fa_77711_800x0_resize_lanczos_3.png 800w,
/posts/allwinner-s3-videoencoders/images/Cpuarch_hufaef179a65db8d6c26b65a1ab82f38fa_77711_2160x0_resize_lanczos_3.png 2160w" src=/posts/allwinner-s3-videoencoders/images/Cpuarch_hufaef179a65db8d6c26b65a1ab82f38fa_77711_800x0_resize_lanczos_3.png alt></figure><p>What was appealing to me for use with the Boson thermal camera is the compact BGA package, the internal DRAM, and embedded ethernet 100 Mbit PHY.
Interestingly the CPU used inside is the same as the V3/V3s/S3, there is mainline kernel and uboot support. This is good because I&rsquo;m very much an embedded Linux beginner.</p><p>After following the reference design provided by SOChip, along with some other great OSHW projects:</p><ul><li><a href=https://github.com/Jana-Marie/OtterCam-s3>OtterCam-s3</a></li><li><a href=https://github.com/Ottercast/OtterCastAudioV2>OtterCast</a></li><li><a href=https://github.com/OLIMEX/S3-OLinuXino>S3-OLinuXino</a></li></ul><p>I had a custom board designed. After some quick assembly I had a board that powered up.
Soon after that with a custom buildroot project, and had linux 5.18 booted on the board. üôå</p><figure><img srcset="/posts/allwinner-s3-videoencoders/images/001_hu0d1320b2fd75f0ddabac903df3caaea1_1560087_390x0_resize_q95_lanczos.jpeg 390w,
/posts/allwinner-s3-videoencoders/images/001_hu0d1320b2fd75f0ddabac903df3caaea1_1560087_800x0_resize_q95_lanczos.jpeg 800w,
/posts/allwinner-s3-videoencoders/images/001_hu0d1320b2fd75f0ddabac903df3caaea1_1560087_2160x0_resize_q95_lanczos.jpeg 2160w" src=/posts/allwinner-s3-videoencoders/images/001_hu0d1320b2fd75f0ddabac903df3caaea1_1560087_800x0_resize_q95_lanczos.jpeg alt></figure><h2 id=h264-encoder>H264 Encoder<a hidden class=anchor aria-hidden=true href=#h264-encoder>#</a></h2><p>After some initial testing with libopenh264 with ffmpeg the performance is not great. Achieving only a few fps encoding an incoming USB UVC stream into h264. Not a dealbreaker for this project.</p><p>The S3 contains a hardware encoding block that claims performance of 120FPS, this block is the same across many Allwinner parts. One such part is the H3. Unfortunately it&rsquo;s not documented by Allwinner.
If you want to make use of the codec you&rsquo;ll need to use the older kernel provided by Allwinner, and their cedar core.</p><p>Cedrus is an open source alternative that makes use of community documentation of the codec registers. It&rsquo;s available upstream in the kernel. Great! Except it only handles decoding not encoding. :(</p><hr><p>Searching around I found some older posts talking about hw encode on the Allwinner H3.</p><figure><img srcset="/posts/allwinner-s3-videoencoders/images/004_hu2cf32da3e049178302f49162c612f021_114645_390x0_resize_lanczos_3.png 390w,
/posts/allwinner-s3-videoencoders/images/004_hu2cf32da3e049178302f49162c612f021_114645_800x0_resize_lanczos_3.png 800w,
/posts/allwinner-s3-videoencoders/images/004_hu2cf32da3e049178302f49162c612f021_114645_2160x0_resize_lanczos_3.png 2160w" src=/posts/allwinner-s3-videoencoders/images/004_hu2cf32da3e049178302f49162c612f021_114645_800x0_resize_lanczos_3.png alt></figure><blockquote><p><a href=https://forum.armbian.com/topic/11551-4kp30-video-on-orange-pi-lite-and-mainline-hardware-acceleration/page/2/#comment-89815>https://forum.armbian.com/topic/11551-4kp30-video-on-orange-pi-lite-and-mainline-hardware-acceleration/page/2/#comment-89815</a></p></blockquote><p>They mentioned these components:</p><ul><li><a href=https://github.com/uboborov/sunxi-cedar-mainline>https://github.com/uboborov/sunxi-cedar-mainline</a></li><li><a href=https://github.com/uboborov/ffmpeg_h264_H3>https://github.com/uboborov/ffmpeg_h264_H3</a></li><li><a href=https://github.com/uboborov/cedrus>https://github.com/uboborov/cedrus</a></li></ul><h3 id=sunxi-cedar-mainline>sunxi-cedar-mainline<a hidden class=anchor aria-hidden=true href=#sunxi-cedar-mainline>#</a></h3><p>This is a kernel module which when loaded creates <code>/dev/cedar_ve</code>. This file facilitates the interaction from a userspace app to the low level codec block.
What is interesting is that this project specifically list Kernel 5.7, with config. It makes use of the CMA, Continuous Memory Allocator, a part of the Linux mainline Kernel. Many repos for &ldquo;cedar&rdquo; seem to use an older ION system from Android, and are pinned to old kernel versions.</p><h3 id=ffmpeg_h264_h3>ffmpeg_h264_H3<a hidden class=anchor aria-hidden=true href=#ffmpeg_h264_h3>#</a></h3><p>This is a custom encoder that compiles into FFmpeg. Unfortunately this version does make use of ION, which creates a bit of a disconnect between the kernel module and the userspace code&mldr; :/</p><h3 id=cedrus>cedrus<a hidden class=anchor aria-hidden=true href=#cedrus>#</a></h3><p>These small utilities are super handy, they&rsquo;re small single purpose applications <code>h264enc</code>, <code>jpeg-test</code>, <code>mpeg-test</code>.</p><p>The code makes use of the CMA, and also the functions and code layout match up pretty perfectly to the FFmpeg encoder code. Combining this code into the FFmpeg looks like it might be the way to go.</p><h2 id=building>Building<a hidden class=anchor aria-hidden=true href=#building>#</a></h2><p>So it looks like we have all the pieces for this puzzle but can we put them together..</p><p>A very simple <a href=https://github.com/gregdavill/boson-s3-dev-sw/tree/7368333f0b5bcfb46ecb01c36bdba9204f738d78/buildroot/package/cedar>package</a> is added buildroot project to compile the kernel module, this also installs the module into the target filesystem.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>################################################################################
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span># cedar-mainline
</span></span><span style=display:flex><span>#
</span></span><span style=display:flex><span>################################################################################
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>CEDAR_VERSION = cb9ea3d9894fd88a5b7f67fea220ceaa5ed17656
</span></span><span style=display:flex><span>CEDAR_SITE = $(call github,gregdavill,sunxi-cedar-mainline,$(CEDAR_VERSION))
</span></span><span style=display:flex><span>CEDAR_LICENSE = GPL-2.0
</span></span><span style=display:flex><span>CEDAR_LICENSE_FILES = LICENSE
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$(eval $(kernel-module))
</span></span><span style=display:flex><span>$(eval $(generic-package))
</span></span></code></pre></div><p>Along with the kernel module, we need to enable the CMA, because we only have 128MB to work with I first started with 64MB.</p><h4 id=defconfig>defconfig<a hidden class=anchor aria-hidden=true href=#defconfig>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a6e22e>+ CONFIG_DMA_CMA=y
</span></span></span><span style=display:flex><span><span style=color:#a6e22e>+ CONFIG_CMA_SIZE_MBYTES=64
</span></span></span></code></pre></div><h4 id=sun8idtsi>sun8i.dtsi<a hidden class=anchor aria-hidden=true href=#sun8idtsi>#</a></h4><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>	reserved-memory {
</span></span><span style=display:flex><span>            #address-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>			#size-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>			ranges;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			cma_pool: default-pool {
</span></span><span style=display:flex><span>				alloc-ranges = &lt;0x40000000 0x8000000&gt;; // Start Addr + Length
</span></span><span style=display:flex><span>				compatible = &#34;shared-dma-pool&#34;;
</span></span><span style=display:flex><span>				linux,cma-default;
</span></span><span style=display:flex><span>				reusable;
</span></span><span style=display:flex><span>				alignment = &lt;0x2000&gt;;
</span></span><span style=display:flex><span>				size = &lt;0x4000000&gt;; /* 64MB */
</span></span><span style=display:flex><span>			};
</span></span><span style=display:flex><span>	};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    syscon: syscon@1c00000 {
</span></span><span style=display:flex><span>        compatible = &#34;allwinner,sun8i-v3s-system-controller&#34;, &#34;allwinner,sun8i-h3-system-control&#34;, &#34;syscon&#34;;
</span></span><span style=display:flex><span>        reg = &lt;0x01c00000 0xd0&gt;;
</span></span><span style=display:flex><span>        #address-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>        #size-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>        ranges;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        sram_c: sram@4000 {
</span></span><span style=display:flex><span>            compatible = &#34;mmio-sram&#34;;
</span></span><span style=display:flex><span>            reg = &lt;0x4000 0xa000&gt;;
</span></span><span style=display:flex><span>            #address-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>            #size-cells = &lt;1&gt;;
</span></span><span style=display:flex><span>            ranges = &lt;0 0x4000 0xa000&gt;;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            ve_sram: sram-section@0 {
</span></span><span style=display:flex><span>                compatible = &#34;allwinner,sun8i-v3s-sram-c&#34;, &#34;allwinner,sun4i-a10-sram-c1&#34;;
</span></span><span style=display:flex><span>                reg = &lt;0x000000 0xa000&gt;;
</span></span><span style=display:flex><span>            };
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    ve: video-engine@01c0e000 {
</span></span><span style=display:flex><span>        compatible = &#34;allwinner,sunxi-cedar-ve&#34;;
</span></span><span style=display:flex><span>        reg = &lt;0x01c0e000 0x1000&gt;,
</span></span><span style=display:flex><span>                    &lt;0x01c00000 0x10&gt;,
</span></span><span style=display:flex><span>                    &lt;0x01c20000 0x800&gt;;
</span></span><span style=display:flex><span>        memory-region = &lt;&amp;cma_pool&gt;;
</span></span><span style=display:flex><span>        syscon = &lt;&amp;syscon&gt;;
</span></span><span style=display:flex><span>        clocks = &lt;&amp;ccu CLK_BUS_VE&gt;, &lt;&amp;ccu CLK_VE&gt;,
</span></span><span style=display:flex><span>                    &lt;&amp;ccu CLK_DRAM_VE&gt;;
</span></span><span style=display:flex><span>        clock-names = &#34;ahb&#34;, &#34;mod&#34;, &#34;ram&#34;;
</span></span><span style=display:flex><span>        resets = &lt;&amp;ccu RST_BUS_VE&gt;;
</span></span><span style=display:flex><span>        interrupts = &lt;GIC_SPI 58 IRQ_TYPE_LEVEL_HIGH&gt;;
</span></span><span style=display:flex><span>        allwinner,sram = &lt;&amp;ve_sram 1&gt;;
</span></span><span style=display:flex><span>    };
</span></span></code></pre></div><p>A lot of the references I&rsquo;ve seen online to working with this codec seem to set <code>sram_c</code> to <code>0x1d00000</code>. Which seems to be an empty section of memory, according to the official memory map. So I&rsquo;ve set my device tree to point to the <code>sram_c</code> defined in the S3 datasheet, this seems to work correctly, atleast for my use cases.</p><h4 id=kernel-output>Kernel output<a hidden class=anchor aria-hidden=true href=#kernel-output>#</a></h4><pre tabindex=0><code>[    0.000000] Reserved memory: created CMA memory pool at 0x43c00000, size 64 MiB
[    0.000000] OF: reserved mem: initialized node default-pool, compatible id shared-dma-pool
...
[    0.000000] Zone ranges:
[    0.000000]   Normal   [mem 0x0000000040000000-0x0000000047ffffff]
[    0.000000]   HighMem  empty
[    0.000000] Memory: 50136K/131072K available (8192K kernel code, 1478K rwdata, 2800K rodata, 1024K init, 240K bss, 15400K reserved, 65536K cma-reserved, 0K highmem)
...

# modprobe cedar_ve
[    9.202456] cedar_ve: loading out-of-tree module taints kernel.
[    9.210073] sunxi cedar version 0.1 
[    9.213939] [cedar]: install start!!!
[    9.217684] cedar_ve: cedar-ve the get irq is 23
[    9.222323] sunxi-cedar 1c0e000.video-engine: assigned reserved memory node default-pool
[    9.230624] [cedar]: Success claim SRAM
[    9.338704] [cedar]: memory allocated at address PA: 43D00000, VA: C3D00000
[    9.345749] [cedar]: install end!!!
</code></pre><p>Success! ü•≥</p><hr><p>The first time I tried this I hit an error trying to allocate memory, because it was attempting to allocate 80MB. Easy fix. Might be better suited to be set up the ve_size as a device tree parameter.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>diff --git a/cedar_ve.c b/cedar_ve.c
</span></span><span style=display:flex><span>index 2f6f744..c73ea88 100644
</span></span><span style=display:flex><span><span style=color:#f92672>--- a/cedar_ve.c
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+++ b/cedar_ve.c
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span><span style=color:#75715e>@@ -1804,7 +1804,7 @@ static int cedardev_init(struct platform_device *pdev)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> #endif /*LINUX_VERSION_CODE &gt;= KERNEL_VERSION(4,11,0)*/
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span> #if !defined(USE_ION)
</span></span><span style=display:flex><span><span style=color:#f92672>-	cedar_devp-&gt;ve_size = 80 * SZ_1M;
</span></span></span><span style=display:flex><span><span style=color:#f92672></span><span style=color:#a6e22e>+	cedar_devp-&gt;ve_size = 32 * SZ_1M;
</span></span></span><span style=display:flex><span><span style=color:#a6e22e></span> 	ret = dma_set_coherent_mask(cedar_devp-&gt;dev, DMA_BIT_MASK(32));
</span></span><span style=display:flex><span> 	if (ret) {
</span></span><span style=display:flex><span> 		dev_err(cedar_devp-&gt;dev, &#34;DMA enable failed\n&#34;);
</span></span></code></pre></div><hr><p>New we have the kernel module loaded it&rsquo;s time to set up FFmpeg.
Here is a diff I&rsquo;ve applied to <a href=https://github.com/gregdavill/FFmpeg/compare/release/4.4...gregdavill:FFmpeg:cedrus264>FFmpeg 4.4</a></p><h2 id=results>Results<a hidden class=anchor aria-hidden=true href=#results>#</a></h2><figure><img srcset="/posts/allwinner-s3-videoencoders/images/003_hu28e7cdf1e2a8b445e9b6aaded8c93ab1_248041_390x0_resize_lanczos_3.png 390w,
/posts/allwinner-s3-videoencoders/images/003_hu28e7cdf1e2a8b445e9b6aaded8c93ab1_248041_800x0_resize_lanczos_3.png 800w,
/posts/allwinner-s3-videoencoders/images/003_hu28e7cdf1e2a8b445e9b6aaded8c93ab1_248041_2160x0_resize_lanczos_3.png 2160w" src=/posts/allwinner-s3-videoencoders/images/003_hu28e7cdf1e2a8b445e9b6aaded8c93ab1_248041_800x0_resize_lanczos_3.png alt></figure><hr><p>Not an apple to oranges comparison, because the h264 parameters are different. But you can see even on the &ldquo;ultrafast&rdquo; preset, the speed can&rsquo;t keep up with a measly 30 fps 640x512 stream.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span># ffmpeg -f v4l2 -video_size 640x512 -pix_fmt nv12 -i /dev/video0 -r 30 -c:v cedrus264 -vewait 5 -b:v 4M -maxrate 4M -qp 30 -t 5 -f mp4 test.mp4 -y
</span></span><span style=display:flex><span>frame=  150 fps= 30 q=-0.0 Lsize=     558kB time=00:00:04.96 bitrate= 921.1kbits/s speed=0.994x    
</span></span><span style=display:flex><span># ffmpeg -f v4l2 -video_size 640x512 -pix_fmt nv12 -i /dev/video0 -r 30 -c:v libx264 -b:v 4M -maxrate 4M -bufsize 1M -preset ultrafast -t 5  -f mp4 test.mp4 -y 
</span></span><span style=display:flex><span>frame=  150 fps= 20 q=7.0 Lsize=    2380kB time=00:00:04.96 bitrate=3925.5kbits/s dup=24 drop=0 speed=0.66x 
</span></span></code></pre></div><p>I&rsquo;ve only really started to poke around with the encoder support. But hope this write-up encourages you to give it a spin too! I&rsquo;d love to see any projects you come up with utilizing the Allwinner S3!</p></div><footer class=post-footer><ul class=post-tags></ul><nav class=paginav><a class=prev href=https://gregdavill.com/posts/2022-07-18-new-d20-panels/><span class=title>¬´ Prev</span><br><span>d20: Panel Photos</span>
</a><a class=next href=https://gregdavill.com/posts/ezfet-summary/><span class=title>Next ¬ª</span><br><span>MSP430 custom ezFET Lite</span></a></nav></footer><div id=hyvor-talk-view></div><script type=text/javascript>dark_palette={accent:"#ffffff",accentText:"#000000",footerHeader:"#1b1818",footerHeaderText:"#cac7c7",box:"#232121",boxText:"#ffffff",boxLightText:"#aaaaaa",backgroundText:"#ffffff"},light_palette={accent:"#659DBD",accentText:"#FFFFFF",footerHeader:"#FAFAFA",footerHeaderText:"#484848",box:"#FFFFFF",boxText:"#111111",boxLightText:"#AAAAAA",backgroundText:"#111111"};var palette=light_palette,HYVOR_TALK_WEBSITE,HYVOR_TALK_CONFIG;document.body.className.includes("dark")&&(palette=dark_palette),HYVOR_TALK_WEBSITE=5683,HYVOR_TALK_CONFIG={url:!1,id:"9b3dcb7f405f394fb0b21003a225acca",palette},document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?hyvor_talk.setPalette(light_palette):hyvor_talk.setPalette(dark_palette)})</script><script async type=text/javascript src=//talk.hyvor.com/web-api/embed.js></script></article></main><footer class=footer><span>&copy; 2024 <a href=https://gregdavill.com/>Greg Davill's Projects</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script src=https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin=anonymous referrerpolicy=no-referrer></script><script>light_bg="rgb(255, 255, 255)",dark_bg="rgb(29, 30, 32)";var palette_bg=light_bg;document.body.className.includes("dark")&&(palette_bg=dark_bg),document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?palette_bg=light_bg:palette_bg=dark_bg;const e=Array.from(document.querySelectorAll(".post-content img"));e.forEach(e=>{mediumZoom(e,{margin:0,background:palette_bg,scrollOffset:40,container:null,template:null})})});const images=Array.from(document.querySelectorAll(".post-content img"));images.forEach(e=>{mediumZoom(e,{margin:0,background:palette_bg,scrollOffset:40,container:null,template:null})})</script><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>